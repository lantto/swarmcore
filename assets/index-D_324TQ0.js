var pe=Object.defineProperty;var me=(t,e,n)=>e in t?pe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var A=(t,e,n)=>me(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const fe=`
  attribute vec4 aPosition;

  void main() {
      gl_Position = aPosition;
  }
`,Ce=`
  precision highp float;
  
  uniform sampler2D uEntityTexture;
  uniform vec2 uTextureSize;
  uniform vec2 uCanvasSize;
  uniform float uTime;
  uniform vec2 uRallyPoint;
  uniform float uRallyPointFadeTime;

  vec4 createGlow(vec2 uv) {
      vec4 glowColor = vec4(0.0);
      float intensity = 0.0;
      float glow = 5.0;
      
      for (float x = -5.0; x <= 5.0; x += 1.0) {
          for (float y = -5.0; y <= 5.0; y += 1.0) {
              // Skip the corners
              if (abs(x) + abs(y) > 7.0) continue;

              vec2 offset = vec2(x, y) / uTextureSize;
              vec4 sampleColor = texture2D(uEntityTexture, uv + offset);
              glowColor += sampleColor;
              intensity += sampleColor.a;
          }
      }
      
      intensity = intensity / (glow * glow);
      glowColor = glowColor / (glow * glow);
      return vec4(glowColor.rgb, intensity);
  }

  // Updated function for rally point effect
  float createRallyPointEffect(vec2 uv, vec2 rallyPoint, float time, float fadeTime) {
      vec2 rallyPointUV = rallyPoint / uCanvasSize;
      rallyPointUV.y = 1.0 - rallyPointUV.y;  // Flip the Y coordinate
      
      // Calculate aspect ratio
      float aspectRatio = uCanvasSize.x / uCanvasSize.y;
      
      // Adjust UV coordinates to maintain circular shape
      vec2 adjustedUV = uv;
      adjustedUV.x *= aspectRatio;
      vec2 adjustedRallyPointUV = rallyPointUV;
      adjustedRallyPointUV.x *= aspectRatio;
      
      // Calculate vector from rally point to current position
      vec2 toPixel = adjustedUV - adjustedRallyPointUV;
      
      // Calculate distance from rally point
      float dist = length(toPixel) / aspectRatio;
      
      // Create pulsating circle effect
      float pulse = sin(time * 3.0) * 0.5 + 0.5;
      float circle = smoothstep(0.05 + pulse * 0.03, 0.0, dist);
      
      // Add subtle waves radiating from the rally point
      float waves = sin(dist * 30.0 - time * 5.0) * 0.5 + 0.5;
      waves *= smoothstep(0.2, 0.0, dist);
      
      // Calculate fade factor
      float fadeOutDuration = 5.0;
      float fadeOutStart = fadeTime;
      float fadeOutEnd = fadeOutStart + fadeOutDuration;
      float fadeFactor = 1.0 - clamp((time - fadeOutStart) / fadeOutDuration, 0.0, 1.0);
      
      return (circle + waves * 0.3) * fadeFactor;
  }

  void main() {
      vec2 texCoord = gl_FragCoord.xy / uCanvasSize;
      vec4 entity = texture2D(uEntityTexture, texCoord);
      vec4 glow = createGlow(texCoord);
      
      // Add pulsating effect
      float pulse = (sin(uTime * 2.0) + 1.0) * 0.5;
      glow *= mix(0.5, 1.5, pulse);
      
      // Create rally point effect
      float rallyEffect = createRallyPointEffect(texCoord, uRallyPoint, uTime, uRallyPointFadeTime);
      
      vec3 bgColor = vec3(0.0, 0.0, 0.0);  // Pitch black background
      vec3 rallyColor = vec3(0.1, 0.1, 0.2) * rallyEffect;
      
      if (entity.a > 0.0) {
          gl_FragColor = mix(vec4(bgColor + rallyColor, 1.0), entity, entity.a);
      } else if (glow.a > 0.0) {
          gl_FragColor = mix(vec4(bgColor + rallyColor, 1.0), glow, glow.a);
      } else {
          gl_FragColor = vec4(bgColor + rallyColor, 1.0);
      }
  }
`;function xe(t,e,n){const o=q(t,t.VERTEX_SHADER,e),r=q(t,t.FRAGMENT_SHADER,n),s=t.createProgram();return t.attachShader(s,o),t.attachShader(s,r),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS)?s:(console.error("Unable to initialize the shader program: "+t.getProgramInfoLog(s)),null)}function q(t,e,n){const o=t.createShader(e);return t.shaderSource(o,n),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(console.error("An error occurred compiling the shaders: "+t.getShaderInfoLog(o)),t.deleteShader(o),null)}function Ee(t){const e=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),n=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),{position:n}}function ve(t,e,n,o,r){t.viewport(0,0,t.canvas.width,t.canvas.height),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(e.program),t.bindBuffer(t.ARRAY_BUFFER,n.position),t.enableVertexAttribArray(e.attribLocations.aPosition),t.vertexAttribPointer(e.attribLocations.aPosition,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,o),t.uniform1i(e.uniformLocations.uEntityTexture,0),t.uniform2f(e.uniformLocations.uTextureSize,Math.ceil(t.canvas.width*H),Math.ceil(t.canvas.height*H)),t.uniform2f(e.uniformLocations.uCanvasSize,t.canvas.width,t.canvas.height),t.uniform1f(e.uniformLocations.uTime,performance.now()/1e3),t.uniform2f(e.uniformLocations.uRallyPoint,r.rallyPoint.x,r.rallyPoint.y),t.uniform1f(e.uniformLocations.uRallyPointFadeTime,r.rallyPointFadeTime/1e3),t.drawArrays(t.TRIANGLES,0,6)}function V(t,e,n){const o=window.innerWidth,r=window.innerHeight;(t.width!==o||t.height!==r)&&(t.width=o,t.height=r,e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.width,t.height,0,e.RGBA,e.UNSIGNED_BYTE,null))}const H=.25;let U;function Se(t,e){U=e,Re(t),Me(t.zoomLevel),De(),_e(),Fe(),ze(),Xe()}function Re(t){const e=Pe();ge(e,t),we(e,t),be(e),Te(e,t),document.body.appendChild(e)}function ge(t,e){const n=document.createElement("label");n.textContent="Entity Radius: ";const o=document.createElement("input");o.id="radiusSlider",o.type="range",o.min="1",o.max="19",o.value=e.entityRadius.toString(),o.oninput=i=>{U({entityRadius:parseFloat(i.target.value)})},t.appendChild(n),t.appendChild(o),t.appendChild(document.createElement("br"));const r=document.createElement("label");r.textContent="Random Radius: ";const s=document.createElement("input");s.id="randomRadiusCheckbox",s.type="checkbox",s.checked=e.isRandomRadius,s.onchange=i=>{U({isRandomRadius:i.target.checked})},t.appendChild(r),t.appendChild(s),t.appendChild(document.createElement("br"))}function we(t,e){const n=document.createElement("label");n.textContent="Base Speed: ";const o=document.createElement("input");o.id="baseSpeedSlider",o.type="range",o.min="0.05",o.max="4.0",o.step="0.05",o.value=e.baseSpeed.toString(),o.oninput=i=>{U({baseSpeed:parseFloat(i.target.value)})},t.appendChild(n),t.appendChild(o),t.appendChild(document.createElement("br"));const r=document.createElement("label");r.textContent="Random Base Speed: ";const s=document.createElement("input");s.id="randomBaseSpeedCheckbox",s.type="checkbox",s.checked=e.isRandomBaseSpeed,s.onchange=i=>{U({isRandomBaseSpeed:i.target.checked})},t.appendChild(r),t.appendChild(s),t.appendChild(document.createElement("br"))}function be(t){const e=document.createElement("button");e.textContent="Clear Entities",e.onclick=()=>{U({entities:[]})},t.appendChild(e)}function Te(t,e){const n=document.createElement("button");n.textContent=e.isCollisionEnabled?"Disable Collision":"Enable Collision",n.onclick=()=>{U({isCollisionEnabled:!e.isCollisionEnabled}),n.textContent=e.isCollisionEnabled?"Disable Collision":"Enable Collision"},t.appendChild(n),t.appendChild(document.createElement("br"))}function Me(t){const e=Ae(),n=G("Zoom In",()=>U({zoomLevel:t+.1})),o=G("Zoom Out",()=>U({zoomLevel:t-.1})),r=G("Reset Zoom",()=>U({zoomLevel:1}));e.appendChild(n),e.appendChild(o),e.appendChild(r),document.body.appendChild(e)}function Pe(){const t=document.createElement("div");return t.style.position="fixed",t.style.bottom="10px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.color="white",t.style.fontFamily="Arial, sans-serif",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.padding="10px",t.style.borderRadius="5px",t.style.display="none",t}function Ae(){const t=document.createElement("div");return t.style.position="fixed",t.style.top="10px",t.style.right="10px",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.padding="10px",t.style.borderRadius="5px",t.style.display="none",t}function G(t,e){const n=document.createElement("button");return n.textContent=t,n.onclick=e,n}function De(){const t=document.createElement("div");t.id="uiContainer",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.color="white",t.style.fontFamily="Arial, sans-serif",t.style.fontSize="24px",t.style.textAlign="center";const e=document.createElement("div");e.style.width="100%",e.style.height="10px",e.style.backgroundColor="rgba(0, 0, 0, 0.2)",e.style.borderRadius="5px",e.style.overflow="hidden";const n=document.createElement("div");n.id="spawnProgressBar",n.style.width="100%",n.style.height="100%",n.style.position="relative",n.style.boxShadow="0 1px 3px rgba(0, 0, 0, 0.2)";const o=document.createElement("div");o.id="spawnProgressGradient",o.style.position="absolute",o.style.left="0",o.style.top="0",o.style.height="100%",o.style.width="0%",n.appendChild(o),e.appendChild(n);const r=document.createElement("div");r.style.display="flex",r.style.justifyContent="space-between",r.style.padding="5px 20px";const s=document.createElement("div");s.id="levelCount",s.style.textAlign="left",s.style.textShadow="2px 2px 4px rgba(0,0,0,0.5)";const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column",i.style.alignItems="center",i.style.justifyContent="center";const a=document.createElement("span");a.textContent="Creatures",a.style.textShadow="2px 2px 4px rgba(0,0,0,0.5)";const c=document.createElement("span");c.id="entityCount",c.style.color="#00FF00",c.style.textShadow="2px 2px 4px rgba(0,0,0,0.5)",c.style.fontSize="28px",i.appendChild(a),i.appendChild(c),r.appendChild(s),r.appendChild(i),t.appendChild(e),t.appendChild(r),document.body.appendChild(t)}function ie(t,e,n){const o=document.getElementById("spawnProgressGradient");if(o){o.style.width=`${t*100}%`;const r=`linear-gradient(90deg, rgba(${e.join(",")},0.0) 0%, rgba(${n.join(",")},0.8) 100%)`;o.style.background=r}}function Le(t){const e=document.getElementById("radiusSlider");e&&(e.value=t.toString())}function Be(t){const e=document.getElementById("randomRadiusCheckbox");e&&(e.checked=t)}let W=null,Z=0;function re(t){const e=document.getElementById("entityCount");e&&(e.textContent=`${t}`,W!==t&&(e.classList.remove("pulse-animation"),e.offsetWidth,e.classList.add("pulse-animation"),W=t))}function Ue(t){const e=document.getElementById("levelCount");e&&t!==Z&&(e.textContent=`Level: ${t}`,Z=t)}function Fe(){const t=document.createElement("style");t.textContent=`
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(2); }
            100% { transform: scale(1); }
        }
        .pulse-animation {
            animation: pulse 0.3s ease-in-out;
        }
    `,document.head.appendChild(t)}function _e(){const t=document.createElement("div");t.id="depletionBarContainer",t.style.position="fixed",t.style.bottom="0",t.style.left="0",t.style.width="100%",t.style.height="10px",t.style.backgroundColor="rgba(0, 0, 0, 0.2)",t.style.borderRadius="5px",t.style.overflow="hidden";const e=document.createElement("div");e.id="depletionBar",e.style.width="100%",e.style.height="100%",e.style.position="relative",e.style.boxShadow="0 1px 3px rgba(0, 0, 0, 0.2)";const n=document.createElement("div");n.id="depletionGradient",n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.height="100%",n.style.width="10%",e.appendChild(n),t.appendChild(e),document.body.appendChild(t)}function Ie(t,e,n){const o=document.getElementById("depletionGradient");if(o){o.style.width=`${t*100}%`;const r=`linear-gradient(90deg, rgba(${e.join(",")},0.0) 0%, rgba(${n.join(",")},0.8) 100%)`;o.style.background=r}}function ze(){const t=document.createElement("div");t.id="stageContainer",t.style.position="fixed",t.style.bottom="20px",t.style.left="0",t.style.width="100%",t.style.display="flex",t.style.justifyContent="space-between",t.style.padding="0 20px",t.style.color="white",t.style.fontFamily="Arial, sans-serif",t.style.fontSize="16px";const e=document.createElement("div");e.id="currentStage";const n=document.createElement("div");n.id="nextStage",t.appendChild(e),t.appendChild(n),document.body.appendChild(t)}function Ne(t,e){const n=document.getElementById("currentStage"),o=document.getElementById("nextStage");n&&o&&(n.textContent=`Stage: ${t}`,o.textContent=`Next stage: ${(e*100).toFixed(2)}%`)}function Xe(){const t=document.createElement("div");t.id="levelUpCard",t.style.position="fixed",t.style.top="25%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.backgroundColor="rgba(0, 0, 0, 0.8)",t.style.color="white",t.style.padding="20px",t.style.borderRadius="10px",t.style.textAlign="center",t.style.fontSize="24px",t.style.opacity="0",t.style.transition="opacity 0.5s ease-in-out",t.style.zIndex="1000",t.style.display="none",document.body.appendChild(t)}let I=null;function Oe(t,e,n,o,r,s,i){const a=document.getElementById("levelUpCard");if(a){I!==null&&clearTimeout(I),a.innerHTML=`
      <h2>Stage ${t} Reached!</h2>
      <p>Speed: ${e.toFixed(2)} → ${n.toFixed(2)}</p>
      <p>Starting creatures: ${s} → ${i}</p>
      <p>Variation: ${o.toFixed(2)} → ${r.toFixed(2)}</p>
    `,a.style.display="block",a.style.transform="translate(-50%, -50%) scale(0.5)",a.style.opacity="0",setTimeout(()=>{a.style.transition="transform 0.3s ease-out, opacity 0.3s ease-out",a.style.transform="translate(-50%, -50%) scale(1.1)",a.style.opacity="1"},50),setTimeout(()=>{a.style.transform="translate(-50%, -50%) scale(1)"},300);const c=()=>{a.style.transition="transform 0.3s ease-in, opacity 0.3s ease-in",a.style.transform="translate(-50%, -50%) scale(0.5)",a.style.opacity="0",setTimeout(()=>{a.style.display="none",a.removeEventListener("click",c)},300),I!==null&&(clearTimeout(I),I=null)};a.removeEventListener("click",c),a.addEventListener("click",c),I=window.setTimeout(c,1e4)}}function $e(t,e,n){t.addEventListener("mousedown",o=>K(o,e,n)),t.addEventListener("mousemove",o=>J(o,e,n)),t.addEventListener("mouseup",()=>O(e,n)),t.addEventListener("mouseleave",()=>O(e,n)),t.addEventListener("touchstart",o=>K(o,e,n)),t.addEventListener("touchmove",o=>J(o,e,n)),t.addEventListener("touchend",()=>O(e,n)),t.addEventListener("touchcancel",()=>O(e,n))}function K(t,e,n){t.preventDefault(),se(t,e,n),n({mouseState:{...e.mouseState,isDown:!0}}),e.isResourcesDepleting||ae(e,n)}function J(t,e,n){t.preventDefault(),se(t,e,n),e.mouseState.isDown&&!e.isResourcesDepleting&&ae(e,n)}function O(t,e){t.mouseState.isDown&&e({mouseState:{...t.mouseState,isDown:!1},rallyPointFadeTime:performance.now()})}function se(t,e,n){const o=t.target.getBoundingClientRect();let r,s;t instanceof MouseEvent?(r=t.clientX-o.left,s=t.clientY-o.top):(r=t.touches[0].clientX-o.left,s=t.touches[0].clientY-o.top),n({mouseState:{...e.mouseState,x:r,y:s}})}function ae(t,e){e({rallyPoint:{x:t.mouseState.x,y:t.mouseState.y},rallyPointFadeTime:performance.now()})}class z{constructor(e,n,o,r){A(this,"x");A(this,"y");A(this,"w");A(this,"h");this.x=e,this.y=n,this.w=o,this.h=r}contains(e){return e.x>=this.x&&e.x<this.x+this.w&&e.y>=this.y&&e.y<this.y+this.h}intersects(e){return!(this.x+this.w<e.x||this.x>e.x+e.w||this.y+this.h<e.y||this.y>e.y+e.h)}}class N{constructor(e,n){A(this,"boundary");A(this,"capacity");A(this,"entities");A(this,"divided");A(this,"northwest");A(this,"northeast");A(this,"southwest");A(this,"southeast");this.boundary=e,this.capacity=n,this.entities=[],this.divided=!1,this.northwest=null,this.northeast=null,this.southwest=null,this.southeast=null}insert(e){return this.boundary.contains(e)?this.entities.length<this.capacity&&!this.divided?(this.entities.push(e),!0):(this.divided||this.subdivide(),this.northwest.insert(e)||this.northeast.insert(e)||this.southwest.insert(e)||this.southeast.insert(e)):!1}subdivide(){const e=this.boundary.x,n=this.boundary.y,o=this.boundary.w/2,r=this.boundary.h/2;this.northwest=new N(new z(e,n,o,r),this.capacity),this.northeast=new N(new z(e+o,n,o,r),this.capacity),this.southwest=new N(new z(e,n+r,o,r),this.capacity),this.southeast=new N(new z(e+o,n+r,o,r),this.capacity),this.divided=!0;for(let s of this.entities)this.insert(s);this.entities=[]}query(e,n=[]){if(!this.boundary.intersects(e))return n;for(let o of this.entities)e.contains(o)&&n.push(o);return this.divided&&(this.northwest.query(e,n),this.northeast.query(e,n),this.southwest.query(e,n),this.southeast.query(e,n)),n}}const ce=Math.sqrt(3),Ge=.5*(ce-1),X=(3-ce)/6,Q=t=>Math.floor(t)|0,ee=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function ke(t=Math.random){const e=Ye(t),n=new Float64Array(e).map(r=>ee[r%12*2]),o=new Float64Array(e).map(r=>ee[r%12*2+1]);return function(s,i){let a=0,c=0,d=0;const p=(s+i)*Ge,C=Q(s+p),l=Q(i+p),x=(C+l)*X,u=C-x,m=l-x,y=s-u,S=i-m;let E,v;y>S?(E=1,v=0):(E=0,v=1);const g=y-E+X,w=S-v+X,D=y-1+2*X,f=S-1+2*X,R=C&255,T=l&255;let M=.5-y*y-S*S;if(M>=0){const b=R+e[T],F=n[b],_=o[b];M*=M,a=M*M*(F*y+_*S)}let L=.5-g*g-w*w;if(L>=0){const b=R+E+e[T+v],F=n[b],_=o[b];L*=L,c=L*L*(F*g+_*w)}let P=.5-D*D-f*f;if(P>=0){const b=R+1+e[T+1],F=n[b],_=o[b];P*=P,d=P*P*(F*D+_*f)}return 70*(a+c+d)}}function Ye(t){const n=new Uint8Array(512);for(let o=0;o<512/2;o++)n[o]=o;for(let o=0;o<512/2-1;o++){const r=o+~~(t()*(256-o)),s=n[o];n[o]=n[r],n[r]=s}for(let o=256;o<512;o++)n[o]=n[o-256];return n}const k=[[0,0,0,1,0,0,0,0,0,0],[0,0,0,1,1,0,0,1,1,1],[1,1,1,1,1,1,0,1,1,1],[0,0,0,1,1,0,0,1,1,1],[0,0,0,1,0,0,0,0,0,0]],B=8,te={SCARCE:1,ABUNDANT:2};function je(t,e,n){return[Math.round(e[0]+(n[0]-e[0])*t),Math.round(e[1]+(n[1]-e[1])*t),Math.round(e[2]+(n[2]-e[2])*t)]}function qe(t,e=2){return Math.pow(t,e)}function le(t,e,n,o,r,s,i=te.ABUNDANT,a=5){const c=[],d=Math.floor(t/B),p=Math.floor(e/B),C=ke(),l=.02,x=d/2,u=p/2,m=20,y=10,S=i===te.SCARCE?200*n:2e3*n,E=[];let v=1/0,g=-1/0;for(let f=y;f<d-y;f++)for(let R=y;R<p-y;R++){const T=f-x,M=R-u;if(T*T+M*M>m*m){const P=C(f*l,R*l);E.push([f,R,P]),v=Math.min(v,P),g=Math.max(g,P)}}E.forEach(f=>{f[2]=(f[2]-v)/(g-v)}),E.sort((f,R)=>R[2]-f[2]);const w=E.slice(0,S),D=Math.log2(n+1);for(const[f,R,T]of w){if(o.has(`${f},${R}`))continue;const M=qe(T,100*D);let b=je(M,s||[200,200,200],r||[0,0,128]);b=b.map(F=>Math.round(F*.7)),b=b.map(F=>{const _=Math.floor(Math.random()*7)-3;return Math.max(0,Math.min(255,F+_))}),c.push({x:f,y:R,health:a,maxHealth:a,color:b})}return c}function de(t){const e=new Map;for(const n of t)e.set(`${n.x},${n.y}`,n);return e}function ue(t,e,n,o){e.clearRect(0,0,n,o);for(const r of t){const s=r.health/r.maxHealth;e.fillStyle=`rgba(${r.color[0]}, ${r.color[1]}, ${r.color[2]}, ${s})`,e.fillRect(r.x,r.y,1,1)}}function Ve(t,e,n){const o=[],r=Math.floor(t/(2*B)),s=Math.floor(e/(2*B)*.5),i=k[0].length,a=k.length,c=r-Math.floor(i/2),d=s-Math.floor(a/2);for(let p=0;p<a;p++)for(let C=0;C<i;C++)if(k[p][C]===1){const l={x:c+C,y:d+p,health:50,maxHealth:50,color:n};o.push(l)}return o}function He(){return[Math.floor(Math.random()*256),Math.floor(Math.random()*256),Math.floor(Math.random()*256)]}const We=5e3,Ze=2e3,he=250,Y={SCARCE:1,ABUNDANT:2};let j=!1;function ye(t,e,n=!1){const o=t.canvas.width/2,r=t.canvas.height/2;if(n)for(let s=0;s<e.initialEntityCount;s++){const i=$(o,r,{...e,entityRadius:4});oe(i,t.canvas.width,t.canvas.height),e.entities.push(i)}else{let s=function(){if(i<e.initialEntityCount){const a=$(o,r,e);oe(a,t.canvas.width,t.canvas.height),e.entities.push(a),i++,setTimeout(s,100)}},i=0;s()}}function Ke(t,e){if(e.entities=[],ye(t,e,!1),e.resources=le(t.canvas.width,t.canvas.height,e.stage,e.resourceCache,e.resourceStartColor,e.resourceEndColor),e.resourceCache=de(e.resources),e.currentResources=e.totalResources=e.resources.reduce((o,r)=>o+r.health,0),Ve(t.canvas.width,t.canvas.height,e.resourceEndColor).forEach(o=>{e.resources.push(o),e.resourceCache.set(`${o.x},${o.y}`,o)}),e.currentResources=3e3,e.totalResources=3e3,e.resourceCtx){const o=e.resourceCtx.canvas;o.width=t.canvas.width/B,o.height=t.canvas.height/B,ue(e.resources,e.resourceCtx,o.width,o.height),e.resourceCtx.setTransform(1,0,0,1,0,0)}}function $(t,e,n){const o=n.isRandomBaseSpeed?Math.random()*(n.baseSpeed-.2)+.2:n.baseSpeed,r=n.isRandomRadius?Math.random()*n.entityRadius+1:n.entityRadius;return{x:t+(Math.random()*20-10),y:e+(Math.random()*20-10),vx:0,vy:0,radius:r,speed:0,baseSpeed:o,lastHitTime:0}}function oe(t,e,n){const o=e/2,r=n/2,s=80,i=Math.random()*2*Math.PI,a=Math.sqrt(Math.random())*s,c=o+a*Math.cos(i),d=r+a*Math.sin(i);t.overrideTarget={x:c,y:d},t.overrideEndTime=performance.now()+Ze}function Je(t,e){if(e.credits>=e.nextSpawnCost){e.level+=1;const s=e.credits-e.credits%e.nextSpawnCost;e.credits-=s,et(t,e,s),e.nextSpawnCost*=2}if(e.isSpawning)for(let i=0;i<5;i++)e.entities.push($(e.mouseState.x,e.mouseState.y,e));const n=new z(0,0,t.canvas.width,t.canvas.height),o=new N(n,4);for(let s of e.entities)o.insert(s);for(let s=0;s<e.entities.length;s++){let i=e.entities[s];const a=performance.now();if(i.overrideEndTime&&a<i.overrideEndTime){const l=i.overrideTarget.x-i.x,x=i.overrideTarget.y-i.y,u=Math.sqrt(l*l+x*x);if(u>1){const m=.1*i.baseSpeed*e.globalSpeedMultiplier;i.vx+=l/u*m,i.vy+=x/u*m}}else{const l=e.rallyPoint.x-i.x,x=e.rallyPoint.y-i.y,u=Math.sqrt(l*l+x*x);if(u>1){const m=.1*i.baseSpeed*e.globalSpeedMultiplier;i.vx+=l/u*m,i.vy+=x/u*m}}i.x+=i.vx,i.y+=i.vy,i.speed=Math.sqrt(i.vx*i.vx+i.vy*i.vy),i.vx*=.95,i.vy*=.95;const c=Math.floor(i.x/B),d=Math.floor(i.y/B),p=`${c},${d}`,C=1;if(e.resourceCache.has(p)){const l=e.resourceCache.get(p),x=(c+.5)*B,u=(d+.5)*B,m=i.x-x,y=i.y-u,S=Math.sqrt(m*m+y*y),E=m/S,v=y/S,g=5;i.vx+=E*g,i.vy+=v*g;const w=i.radius+4;if(S<w&&(i.x=x+E*w,i.y=u+v*w),a-i.lastHitTime>C)l.health-=1;else{i.lastHitTime=a;return}if(i.lastHitTime=a,e.resourceCtx&&e.resourceCtx.clearRect(c,d,1,1),e.credits+=1,e.score+=1,e.currentResources-=1,l.health<=0)e.resourceCache.delete(p),e.resources=e.resources.filter(D=>!(D.x===c&&D.y===d));else if(e.resourceCtx){const D=l.health/l.maxHealth;e.resourceCtx.fillStyle=`rgba(${l.color[0]}, ${l.color[1]}, ${l.color[2]}, ${D})`,e.resourceCtx.fillRect(c,d,1,1)}}if(e.isCollisionEnabled){const l=new z(i.x-i.radius*2,i.y-i.radius*2,i.radius*4,i.radius*4),x=o.query(l);for(let u of x){if(u===i)continue;let m=u.x-i.x,y=u.y-i.y,S=m*m+y*y,E=i.radius+u.radius;if(S<E*E){let v=Math.sqrt(S),g=m/v,w=y/v,D=u.vx-i.vx,f=u.vy-i.vy,R=D*g+f*w;if(R<0){let T=2*R/2;i.vx+=T*g,i.vy+=T*w,u.vx-=T*g,u.vy-=T*w;let M=E-v,L=M*g/2,P=M*w/2;i.x-=L,i.y-=P,u.x+=L,u.y+=P}}}}}e.entities.length>1e3;const r=e.credits/e.nextSpawnCost;ie(r,e.entityStartColor,e.entityEndColor),re(e.entities.length),e.currentResources<e.totalResources/2&&!e.isResourcesDepleting&&(Object.assign(e,{isResourcesDepleting:!0,isCollisionEnabled:!1,rallyPoint:{x:t.canvas.width/2,y:t.canvas.height/2},globalSpeedMultiplier:10}),setTimeout(()=>tt(t,e),We))}function Qe(t,e,n,o){const r=Math.ceil(t.canvas.width*n),s=Math.ceil(t.canvas.height*n),i=new Uint8Array(r*s*4);i.fill(0);for(let a of o.entities){const{x:c,y:d,speed:p}=a,C=Math.round(c*n),l=Math.round(d*n);if(C>=0&&C<r&&l>=0&&l<s){const u=((s-1-l)*r+C)*4,y=Math.min(p/4,1),S=Math.floor(o.entityStartColor[0]+(o.entityEndColor[0]-o.entityStartColor[0])*y),E=Math.floor(o.entityStartColor[1]+(o.entityEndColor[1]-o.entityStartColor[1])*y),v=Math.floor(o.entityStartColor[2]+(o.entityEndColor[2]-o.entityStartColor[2])*y);i[u]=S,i[u+1]=E,i[u+2]=v,i[u+3]=o.isSpeedBasedAlpha?Math.floor(255*y):255}}t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r,s,0,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)}function et(t,e,n){j=!1;const o={radius:Math.random()<.5?4:Math.random()*e.entityRadius+1,baseSpeed:Math.random()*(e.baseSpeed-.2)+.2,isRandomRadius:Math.random()<.5,isRandomBaseSpeed:Math.random()<.5},r=Math.floor(Math.random()*4),s=50+Math.random()*100,i=r%2===0?Math.random()*t.canvas.width:r===1?t.canvas.width+s:-s,a=r%2===1?Math.random()*t.canvas.height:r===0?-s:t.canvas.height+s,c=Math.floor(n/50);let d=0;function p(){if(j){console.log("Entity spawning cancelled");return}if(d<c){const C=$(i,a,{...e,entityRadius:o.radius,baseSpeed:o.baseSpeed,isRandomRadius:o.isRandomRadius,isRandomBaseSpeed:o.isRandomBaseSpeed});e.entities.push(C),d++;const l=10+Math.random()*40;setTimeout(p,l)}}p()}function tt(t,e){j=!0;const n=e.baseSpeed,o=e.entityRadius,r=e.initialEntityCount;e.initialEntityCount+=20,e.entities=[],ye(t,e,!0),e.entityStartColor=He(),e.entityEndColor=[0,255,0],e.resourceStartColor=[0,0,0],e.resourceEndColor=[[0,0,255],[0,128,255],[0,191,255],[65,105,225],[30,144,255],[0,0,139]][Math.floor(Math.random()*6)],e.stage=e.stage+1;const s=e.stage%3===1?Y.ABUNDANT:Y.SCARCE,i=s===Y.SCARCE?50:5,a=le(t.canvas.width,t.canvas.height,e.stage,e.resourceCache,e.resourceStartColor,e.resourceEndColor,s,i);e.resources=[...e.resources,...a],e.resourceCache=de(e.resources),e.totalResources=e.resources.reduce((c,d)=>c+d.health,0),e.entityRadius*=1.2,e.baseSpeed*=1.1,Object.assign(e,{isResourcesDepleting:!1,isCollisionEnabled:!0,globalSpeedMultiplier:1,currentResources:e.totalResources,resourceMultiplier:e.resourceMultiplier*2,credits:0,level:1,entityStartColor:e.entityStartColor,entityEndColor:e.entityEndColor,isSpeedBasedAlpha:Math.random()<.25,rallyPointFadeTime:performance.now()}),e.nextSpawnCost=he,e.resourceCtx&&ue(e.resources,e.resourceCtx,e.resourceCtx.canvas.width,e.resourceCtx.canvas.height),Oe(e.stage,n,e.baseSpeed,o,e.entityRadius,r,e.initialEntityCount)}const ot=.25;let h={entityRadius:4,isRandomRadius:!0,baseSpeed:2,isRandomBaseSpeed:!0,isCollisionEnabled:!0,zoomLevel:1,rallyPoint:{x:0,y:0},isSpawning:!1,entities:[],rallyPointColor:[0,255,0],mouseState:{isDown:!1,x:0,y:0},rallyPointFadeTime:performance.now(),resources:[],resourceCache:new Map,resourceCtx:null,credits:0,score:0,currentResources:0,totalResources:0,isResourcesDepleting:!1,globalSpeedMultiplier:1,resourceMultiplier:1,entityStartColor:[0,0,255],entityEndColor:[0,255,0],resourceStartColor:[0,0,0],resourceEndColor:[0,0,255],isSpeedBasedAlpha:!1,nextSpawnCost:he,level:1,stage:1,initialEntityCount:20};nt();function nt(){const t=document.getElementById("glCanvas"),e=t.getContext("webgl");if(!e){alert("WebGL not supported!");return}const n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.canvas.width,e.canvas.height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),V(e.canvas,e,n),window.addEventListener("resize",()=>V(e.canvas,e,n));const o=xe(e,fe,Ce),r={program:o,attribLocations:{aPosition:e.getAttribLocation(o,"aPosition")},uniformLocations:{uEntityTexture:e.getUniformLocation(o,"uEntityTexture"),uTextureSize:e.getUniformLocation(o,"uTextureSize"),uCanvasSize:e.getUniformLocation(o,"uCanvasSize"),uTime:e.getUniformLocation(o,"uTime"),uRallyPoint:e.getUniformLocation(o,"uRallyPoint"),uRallyPointFadeTime:e.getUniformLocation(o,"uRallyPointFadeTime")}},s=Ee(e);$e(t,h,d=>{Object.assign(h,d),"zoomLevel"in d&&ne(h.zoomLevel)}),Se(h,d=>{Object.assign(h,d),"zoomLevel"in d&&ne(h.zoomLevel)});const i=document.getElementById("resourceCanvas"),a=i.getContext("2d");i.width=t.width,i.height=t.height,i.style.width=`${t.width}px`,i.style.height=`${t.height}px`,h.resourceCtx=a,Ke(e,h),h.rallyPoint={x:t.width/2,y:t.height/2};function c(){Je(e,h),Qe(e,n,ot,h),ve(e,r,s,n,h),Le(h.entityRadius),Be(h.isRandomRadius),re(h.entities.length),Ue(h.level);const d=Math.min(1,(h.totalResources-h.currentResources)/(h.totalResources/2));Ie(d,h.resourceStartColor,h.resourceEndColor);const p=h.credits/h.nextSpawnCost;ie(p,h.entityStartColor,h.entityEndColor),Ne(h.stage,d),requestAnimationFrame(c)}requestAnimationFrame(c)}function ne(t){h.zoomLevel=Math.max(.1,Math.min(5,t));const e=document.getElementById("glCanvas");e.style.transform=`scale(${h.zoomLevel})`,e.style.transformOrigin="center center"}
